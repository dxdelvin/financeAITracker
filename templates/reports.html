{% extends "base.html" %}
{% block main_content %}

<style>
    /* Reports Page Specific Styles */
    .reports-container {
        padding: 2rem;
        max-width: 1400px;
        margin: 0 auto;
    }

    .date-filters {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .filter-btn {
        background: var(--card-bg);
        border: 1px solid #e5e7eb;
        padding: 0.75rem;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .filter-btn.active {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }

    .custom-date-filter {
        display: flex;
        gap: 1rem;
        align-items: center;
        background: var(--card-bg);
        padding: 1rem;
        border-radius: 8px;
    }

    .charts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 2rem;
        margin-top: 2rem;
    }

    .chart-card {
        background: white;
        padding: 1.5rem;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .chart-container {
        position: relative;
        height: 300px;
    }
</style>

<div class="reports-container">
    <h1>Financial Reports</h1>
    
    <!-- Date Filter Section -->
    <div class="date-filters">
        <button class="filter-btn active" data-days="7">Last 7 Days</button>
        <button class="filter-btn" data-days="30">Last 30 Days</button>
        <button class="filter-btn" data-days="365">Last Year</button>
        <button class="filter-btn" data-days="thismonth">This Month</button>
        <button class="filter-btn" data-days="thisyear">This Year</button>
        
        <div class="custom-date-filter">
            <input type="date" id="startDate" class="date-input">
            <span>to</span>
            <input type="date" id="endDate" class="date-input">
            <button id="applyCustom" class="save-btn">Apply</button>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="dashboard-summary">
        <div class="summary-card">
            <h3>Total Income</h3>
            <h2>${{ total_income|floatformat:2 }}</h2>
        </div>
        <div class="summary-card">
            <h3>Total Expenses</h3>
            <h2>${{ total_expenses|floatformat:2 }}</h2>
        </div>
        <div class="summary-card">
            <h3>Net Balance</h3>
            <h2>${{ net_balance|floatformat:2 }}</h2>
        </div>
    </div>

    <!-- Charts Grid -->
    <div class="charts-grid">
        <!-- Income vs Expenses Chart -->
        <div class="chart-card">
            <h3>Income vs Expenses</h3>
            <div class="chart-container">
                <canvas id="incomeExpenseChart"></canvas>
            </div>
        </div>

        <!-- Category Breakdown -->
        <div class="chart-card">
            <h3>Category Breakdown</h3>
            <div class="chart-container">
                <canvas id="categoryChart"></canvas>
            </div>
        </div>

        <!-- Monthly Trend -->
        <div class="chart-card">
            <h3>Monthly Trend</h3>
            <div class="chart-container">
                <canvas id="trendChart"></canvas>
            </div>
        </div>

        <!-- Transaction Type Distribution -->
        <div class="chart-card">
            <h3>Transaction Types</h3>
            <div class="chart-container">
                <canvas id="typeChart"></canvas>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Date Filter Handling
    let currentFilter = '7';
    const filterBtns = document.querySelectorAll('.filter-btn');
    
    filterBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            // Remove active class from all buttons
            filterBtns.forEach(b => b.classList.remove('active'));
            // Add active class to clicked button
            this.classList.add('active');
            currentFilter = this.dataset.days;
            loadChartData(currentFilter);
        });
    });

    // Custom Date Filter
    document.getElementById('applyCustom').addEventListener('click', function() {
        const start = document.getElementById('startDate').value;
        const end = document.getElementById('endDate').value;
        loadChartData('custom', start, end);
    });

    // Chart Initialization
    const chartConfig = {
        maintainAspectRatio: false,
        responsive: true
    };

    // Income vs Expenses Chart (Bar)
    const incomeExpenseChart = new Chart(document.getElementById('incomeExpenseChart'), {
        type: 'bar',
        data: {
            labels: ['Income', 'Expenses'],
            datasets: [{
                label: 'Amount',
                data: [{{ total_income }}, {{ total_expenses }}],
                backgroundColor: ['#10b981', '#ef4444']
            }]
        },
        options: chartConfig
    });

    // Category Breakdown (Pie)
    const categoryChart = new Chart(document.getElementById('categoryChart'), {
        type: 'pie',
        data: {
            labels: {{ categories|safe }},
            datasets: [{
                data: {{ category_amounts|safe }},
                backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#8b5cf6', '#ef4444']
            }]
        },
        options: chartConfig
    });

    // Monthly Trend (Line)
    const trendChart = new Chart(document.getElementById('trendChart'), {
        type: 'line',
        data: {
            labels: {{ months|safe }},
            datasets: [{
                label: 'Income',
                data: {{ monthly_income|safe }},
                borderColor: '#10b981',
                tension: 0.1
            },
            {
                label: 'Expenses',
                data: {{ monthly_expenses|safe }},
                borderColor: '#ef4444',
                tension: 0.1
            }]
        },
        options: chartConfig
    });

    // Type Distribution (Doughnut)
    const typeChart = new Chart(document.getElementById('typeChart'), {
        type: 'doughnut',
        data: {
            labels: ['Income', 'Expenses'],
            datasets: [{
                data: [{{ total_income }}, {{ total_expenses }}],
                backgroundColor: ['#10b981', '#ef4444']
            }]
        },
        options: chartConfig
    });

    // AJAX Function to Load Filtered Data
    function loadChartData(filterType, startDate=null, endDate=null) {
        fetch(`/reports/filter?type=${filterType}&start=${startDate}&end=${endDate}`)
            .then(response => response.json())
            .then(data => {
                // Update all charts with new data
                updateCharts(data);
            });
    }

    function updateCharts(data) {
        incomeExpenseChart.data.datasets[0].data = [data.total_income, data.total_expenses];
        incomeExpenseChart.update();
        
        categoryChart.data.labels = data.categories;
        categoryChart.data.datasets[0].data = data.category_amounts;
        categoryChart.update();
        
        // Similarly update other charts...
    }
});
</script>

{% endblock %}